<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <title id="pageTitle">Study Room - StudyGroup</title>
    <style>
      :root {
        --primary-color: #4caf50;
        --primary-hover: #388e3c;
        --primary-light: #e8f5e8;
        --secondary-color: #2196f3;
        --danger-color: #f44336;
        --dark-text: #333;
        --medium-text: #666;
        --light-text: #888;
        --border-light: #e0e0e0;
        --background-light: #f8f9fa;
        --chat-background: #fafafa;
        --white: #ffffff;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: var(--background-light);
        overflow-x: hidden;
        color: var(--dark-text);
        transition: all 0.3s ease;
      }

      /* Dark Mode Styles */
      body.dark-mode .files-list .text-muted {
        color: #adb5bd !important;
      }

      body.dark-mode .files-list .bi-file-earmark-x {
        color: #adb5bd !important;
      }

      body.dark-mode .text-primary {
        color: #8cdfff !important;
      }

      body.dark-mode .card-body small.text-muted {
        color: #adb5bd !important;
      }

      body.dark-mode #filesList .text-center {
        color: #e0e0e0;
      }
      body.dark-mode {
        --dark-text: #e0e0e0;
        --medium-text: #bbb;
        --light-text: #999;
        --background-light: #1a1a1a;
        --border-light: #333;
        --chat-background: #222;
        --white: #2a2a2a;
        background: #1a1a1a;
        color: #e0e0e0;
      }

      body.dark-mode .sidebar {
        background: linear-gradient(135deg, #2e5d31 0%, #4a7c4f 100%);
      }

      body.dark-mode .top-nav,
      body.dark-mode .room-status-bar,
      body.dark-mode .panel,
      body.dark-mode .chat-container {
        background: #2a2a2a;
        color: #e0e0e0;
      }

      body.dark-mode .participant-item:hover,
      body.dark-mode .chat-message:hover {
        background: #333;
      }

      body.dark-mode .chat-input input {
        background: #333;
        border-color: #444;
        color: #e0e0e0;
      }

      body.dark-mode .chat-input input::placeholder {
        color: #999;
      }

      body.dark-mode .chat-messages {
        background: #222;
      }

      body.dark-mode .video-container {
        background: #222;
        border: 1px solid #444;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
      }

      body.dark-mode .video-header {
        background: #333;
      }

      body.dark-mode .modal-content {
        background: #2a2a2a;
        color: #e0e0e0;
      }

      body.dark-mode .form-control,
      body.dark-mode .form-select {
        background: #333;
        border-color: #444;
        color: #e0e0e0;
      }

      body.dark-mode .form-control::placeholder {
        color: #999;
      }

      body.dark-mode .form-control:focus,
      body.dark-mode .form-select:focus {
        background: #3a3a3a;
        border-color: var(--primary-color);
      }

      body.dark-mode .toast {
        background: #333;
        color: #e0e0e0;
      }

      body.dark-mode .menu-toggle:hover {
        background: #3a3a3a;
      }

      body.dark-mode .message-bubble {
        background: #333;
        color: #e0e0e0;
      }

      body.dark-mode .chat-message.self .message-bubble {
        background: rgba(76, 175, 80, 0.3);
        color: #e0e0e0;
      }

      body.dark-mode .room-status-bar {
        background: rgba(76, 175, 80, 0.2);
      }

      body.dark-mode .nav-tabs .nav-link.active {
        background-color: #333;
        color: #e0e0e0;
        border-color: #444;
      }

      body.dark-mode .nav-tabs .nav-link {
        color: #bbb;
      }

      body.dark-mode .files-list .card {
        background-color: #333;
        border-color: #444;
      }

      /* Sidebar Styles */
      .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        width: 280px;
        height: 100vh;
        background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        transition: left 0.3s ease;
        z-index: 1000;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }

      .sidebar.open {
        left: 0;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-brand {
        color: white;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sidebar-menu {
        padding: 20px 0;
      }

      .sidebar-item {
        display: block;
        color: white;
        text-decoration: none;
        padding: 15px 20px;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
      }

      .sidebar-item:hover,
      .sidebar-item.active {
        background: rgba(255, 255, 255, 0.1);
        border-left-color: white;
        color: white;
      }

      .sidebar-item i {
        width: 20px;
        margin-right: 10px;
      }

      .sidebar-footer {
        position: absolute;
        bottom: 20px;
        width: 100%;
        padding: 0 20px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .user-info:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .main-content {
        margin-left: 0;
        transition: margin-left 0.3s ease;
        min-height: 100vh;
      }

      .main-content.shifted {
        margin-left: 280px;
      }

      /* Top Navigation */
      .top-nav {
        background: white;
        padding: 15px 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .nav-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .menu-toggle {
        background: none;
        border: none;
        font-size: 20px;
        color: var(--medium-text);
        cursor: pointer;
        padding: 8px;
        border-radius: 5px;
        transition: all 0.3s ease;
      }

      .menu-toggle:hover {
        background: #f0f0f0;
      }

      .page-title {
        font-size: 22px;
        font-weight: bold;
        color: var(--dark-text);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .live-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        background: var(--primary-color);
        border-radius: 50%;
        margin-left: 8px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
        }
        70% {
          box-shadow: 0 0 0 6px rgba(76, 175, 80, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
        }
      }

      .theme-toggle {
        background: none;
        border: none;
        font-size: 16px;
        color: var(--medium-text);
        cursor: pointer;
        padding: 6px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .theme-toggle:hover {
        background: var(--background-light);
        transform: scale(1.1);
      }

      .settings-btn {
        background: none;
        border: none;
        color: var(--medium-text);
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }

      .settings-btn:hover {
        background: var(--background-light);
        color: var(--primary-color);
      }

      /* Room Status Bar */
      .room-status-bar {
        background: var(--primary-light);
        border-radius: 10px;
        padding: 15px 20px;
        margin: 20px 30px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .room-info {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
      }

      .room-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-hover);
        display: flex;
        align-items: center;
      }

      .room-meta {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .room-badges {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .room-subtitle {
        font-size: 14px;
        color: var(--medium-text);
        margin-top: 5px;
      }

      .room-actions {
        display: flex;
        gap: 10px;
      }

      .room-action-btn {
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      /* Main Room Layout - Modified for PiP */
      .room-container {
        display: grid;
        grid-template-columns: 1fr 3fr;
        grid-gap: 20px;
        padding: 20px 30px 30px;
        max-width: 1600px;
        margin: 0 auto;
        height: calc(100vh - 140px);
      }

      /* Left Panel - Participants */
      .left-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-height: 100%;
        overflow: hidden;
      }

      .panel {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .panel-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .panel-title {
        font-weight: 600;
        color: var(--dark-text);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .panel-body {
        padding: 15px;
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* Participants List */
      .participants-list {
        flex: 1;
        overflow-y: auto;
      }

      .participant-item {
        padding: 12px 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-radius: 8px;
        transition: background 0.2s;
        position: relative;
      }

      .participant-item:hover {
        background: var(--background-light);
      }

      .participant-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        position: relative;
      }

      .status-indicator {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid var(--white);
      }

      .status-online {
        background: var(--primary-color);
      }

      .status-in-call {
        background: var(--secondary-color);
      }

      .participant-info {
        flex: 1;
        min-width: 0;
      }

      .participant-name {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .participant-status {
        font-size: 12px;
        color: var(--light-text);
      }

      .participant-actions {
        opacity: 0;
        transition: opacity 0.2s;
      }

      .participant-item:hover .participant-actions {
        opacity: 1;
      }

      .kick-btn {
        background: none;
        border: none;
        color: var(--danger-color);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.2s;
      }

      .kick-btn:hover {
        background: rgba(244, 67, 54, 0.1);
      }

      /* Right Panel - Main Chat Area (enhanced) */
      .right-panel {
        display: flex;
        flex-direction: column;
        max-height: 100%;
        overflow: hidden;
        position: relative;
      }

      /* Chat Container (enhanced) */
      .chat-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
        flex: 1;
      }

      .chat-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .chat-title {
        font-weight: 600;
        color: var(--dark-text);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: var(--chat-background);
        display: flex;
        flex-direction: column;
        gap: 15px;
        scroll-behavior: smooth;
      }

      .chat-message {
        display: flex;
        gap: 10px;
        max-width: 90%;
      }

      .chat-message.self {
        align-self: flex-end;
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        font-weight: 600;
        font-size: 13px;
        flex-shrink: 0;
      }

      .message-bubble {
        background: var(--background-light);
        padding: 10px 15px;
        border-radius: 15px;
        border-top-left-radius: 5px;
        position: relative;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .chat-message.self .message-bubble {
        background: var(--primary-light);
        border-top-left-radius: 15px;
        border-top-right-radius: 5px;
      }

      .message-content {
        font-size: 14px;
        margin-bottom: 4px;
        word-break: break-word;
      }

      .message-image {
        max-width: 300px;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 4px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .message-image:hover {
        transform: scale(1.02);
      }

      .message-meta {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: var(--light-text);
      }

      .chat-input {
        padding: 15px;
        display: flex;
        gap: 10px;
        border-top: 1px solid var(--border-light);
        flex-shrink: 0;
        background: var(--white);
      }

      .chat-input input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid var(--border-light);
        border-radius: 20px;
        outline: none;
        transition: all 0.2s ease;
      }

      .chat-input input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
      }

      .chat-actions {
        display: flex;
        gap: 5px;
      }

      .chat-action-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--background-light);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .chat-action-btn:hover {
        background: var(--primary-light);
        color: var(--primary-color);
      }

      .chat-send {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary-color);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .chat-send:hover {
        background: var(--primary-hover);
        transform: scale(1.05);
      }

      /* Video Call Button */
      .video-call-btn {
        position: absolute;
        right: 15px;
        bottom: 80px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 5;
        transition: all 0.3s ease;
      }

      .video-call-btn:hover {
        transform: scale(1.1);
        background: var(--primary-hover);
      }

      .video-call-btn.active {
        background: var(--danger-color);
      }

      .video-call-btn.active:hover {
        background: #d32f2f;
      }

      /* PiP Video Container Styles */
      .video-container {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 360px;
        height: 240px;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        z-index: 1000;
        resize: both;
        border: 2px solid var(--primary-color);
        transition: all 0.3s ease;
        display: none;
      }

      .video-container.active {
        display: flex;
      }

      /* Fullscreen video styles */
      .video-container.maximized {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        max-width: 100% !important;
        max-height: 100% !important;
        border-radius: 0 !important;
        border: none !important;
        transform: none !important;
        z-index: 2000 !important;
        transition: all 0.3s ease;
      }

      /* Make the header more visible in fullscreen mode */
      .video-container.maximized .video-header {
        padding: 15px 20px;
        background: rgba(0, 0, 0, 0.5);
      }

      /* Make the controls easier to see in fullscreen */
      .video-container.maximized .video-controls {
        padding: 15px;
        background: rgba(0, 0, 0, 0.7);
      }

      .video-container.minimized {
        width: 180px;
        height: 120px;
        bottom: 20px;
        right: 20px;
      }

      .video-container.minimized .video-participant {
        display: flex;
      }

      .video-container.minimized .video-controls {
        padding: 5px;
        background: rgba(0, 0, 0, 0.7);
      }

      .video-container.minimized .video-control {
        width: 30px;
        height: 30px;
        font-size: 12px;
      }

      .video-container.dragging {
        opacity: 0.8;
        transform: scale(1.02);
      }

      .video-header {
        background: var(--primary-color);
        color: white;
        padding: 8px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: move;
        user-select: none;
        flex-shrink: 0;
      }

      .maximized-indicator {
        background-color: rgba(255, 255, 255, 0.2);
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 4px;
        margin-left: 8px;
        display: none;
      }

      .video-container.maximized .maximized-indicator {
        display: inline-block;
      }

      .video-title {
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .video-actions {
        display: flex;
        gap: 8px;
      }

      .video-action-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 4px;
        border-radius: 3px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
      }

      .video-action-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .video-body {
        flex: 1;
        background: #1c1c1c;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .video-placeholder {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.7);
        gap: 10px;
        text-align: center;
        padding: 15px;
      }

      .video-grid {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
        padding: 8px;
        overflow: auto;
      }

      .video-participant {
        background: #333;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        aspect-ratio: 16/9;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.7);
      }

      .participant-label {
        position: absolute;
        bottom: 5px;
        left: 5px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
      }

      .video-controls {
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .video-control {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 16px;
      }

      .video-control:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
      }

      .video-control.active {
        background: var(--primary-color);
      }

      .video-control.danger {
        background: var(--danger-color);
      }

      /* Hidden file input */
      .file-input {
        display: none;
      }

      /* Files list styles */
      .files-list {
        max-height: 350px;
        overflow-y: auto;
      }

      .files-list .card {
        transition: transform 0.2s;
      }

      .files-list .card:hover {
        transform: translateY(-2px);
      }

      /* Modals */
      .modal-content {
        border: none;
        border-radius: 10px;
        overflow: hidden;
      }

      .modal-header {
        background: var(--primary-color);
        color: white;
        padding: 15px 20px;
        border-bottom: none;
      }

      .modal-body {
        padding: 20px;
      }

      .modal-footer {
        border-top: none;
        padding: 15px 20px 20px;
      }

      /* Toast Notifications */
      .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
      }

      .toast {
        background: white;
        border-radius: 10px;
        padding: 15px 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        min-width: 300px;
        max-width: 400px;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        0% {
          transform: translateX(100%);
          opacity: 0;
        }
        100% {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .toast.success {
        border-left: 4px solid var(--primary-color);
      }

      .toast.error {
        border-left: 4px solid var(--danger-color);
      }

      .toast.info {
        border-left: 4px solid var(--secondary-color);
      }

      .toast-icon {
        margin-right: 15px;
        font-size: 24px;
      }

      .toast-content {
        flex: 1;
      }

      .toast-title {
        font-weight: bold;
        margin-bottom: 3px;
      }

      .toast-message {
        color: var(--medium-text);
        font-size: 14px;
      }

      .toast-close {
        cursor: pointer;
        color: var(--light-text);
        font-size: 18px;
        margin-left: 15px;
      }

      /* Empty States */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 30px 20px;
        color: var(--light-text);
        height: 100%;
      }

      .empty-state-icon {
        font-size: 40px;
        margin-bottom: 15px;
        opacity: 0.7;
      }

      /* Responsive Design */
      @media (max-width: 992px) {
        .room-container {
          grid-template-columns: 1fr;
          grid-template-areas: "left" "right";
          grid-template-rows: auto;
        }

        .left-panel {
          grid-area: left;
          max-height: 300px;
        }

        .right-panel {
          grid-area: right;
          /* Improved height for chat box on tablets */
          min-height: 500px;
        }

        .video-container {
          width: 240px;
          height: 180px;
          bottom: 70px;
          right: 10px;
        }
      }

      @media (max-width: 768px) {
        .main-content.shifted {
          margin-left: 0;
        }

        .room-status-bar {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
          margin: 15px 15px 0;
        }

        .room-info {
          width: 100%;
        }

        .room-actions {
          width: 100%;
          justify-content: space-between;
        }

        .room-container {
          padding: 15px 15px 20px;
          grid-gap: 15px;
          height: calc(100vh - 180px);
        }

        .left-panel {
          max-height: 250px;
        }

        .right-panel {
          /* Improved height for chat box on mobile */
          min-height: 450px;
          max-height: unset;
        }

        .video-container {
          width: 180px;
          height: 135px;
          bottom: 70px;
          right: 10px;
        }

        .video-call-btn {
          bottom: 75px;
          right: 10px;
          width: 50px;
          height: 50px;
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <i class="bi bi-book"></i>
          StudyGroup
        </div>
      </div>

      <nav class="sidebar-menu">
        <a href="dashboard.html" class="sidebar-item">
          <i class="bi bi-house"></i>
          Dashboard
        </a>
        <a href="profile.html" class="sidebar-item">
          <i class="bi bi-person"></i>
          Profile
        </a>
        <a href="study-rooms.html" class="sidebar-item active">
          <i class="bi bi-door-open"></i>
          Study Rooms
        </a>
        <a href="resources.html" class="sidebar-item">
          <i class="bi bi-folder"></i>
          Resources
        </a>
        <a href="discussion.html" class="sidebar-item">
          <i class="bi bi-chat-dots"></i>
          Discussion Forum
        </a>
        <a href="report.html" class="sidebar-item">
          <i class="bi bi-flag"></i>
          Report
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="user-info" onclick="goToProfile()">
          <div class="user-avatar">DP</div>
          <div>
            <div style="font-weight: bold; font-size: 14px">DanePascual</div>
            <div style="font-size: 12px; opacity: 0.8">BSIT</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <!-- Top Navigation -->
      <div class="top-nav">
        <div class="nav-left">
          <button class="menu-toggle" id="menuToggle">
            <i class="bi bi-list"></i>
          </button>
          <h1 class="page-title" id="roomTitleNav">
            <i class="bi bi-hash"></i>
            <span id="roomNameDisplay">Loading Room...</span>
            <div class="live-indicator" title="Room is active"></div>
          </h1>
        </div>
        <div class="nav-right">
          <button class="theme-toggle" id="themeToggle" title="Toggle theme">
            <i class="bi bi-moon"></i>
          </button>
          <button
            class="settings-btn"
            id="settingsBtn"
            title="Room settings"
            style="display: none"
          >
            <i class="bi bi-gear"></i>
          </button>
          <a href="study-rooms.html" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-box-arrow-left"></i> Leave
          </a>
        </div>
      </div>

      <!-- Room Status Bar -->
      <div class="room-status-bar">
        <div class="room-info">
          <div class="room-title">
            <i class="bi bi-people-fill"></i>
            <span id="roomTitleDisplay">Loading Room...</span>
          </div>
          <div class="room-meta">
            <div class="room-badges">
              <span class="badge bg-success">Active</span>
              <span class="badge bg-light text-dark">Created by You</span>
              <span class="badge bg-info text-white" id="sessionBadge"
                >Session #1</span
              >
            </div>
            <div class="room-subtitle" id="roomCreatedTime">
              Created on 2025-07-11 11:15:22 UTC
            </div>
          </div>
        </div>
        <div class="room-actions">
          <button
            class="btn btn-outline-success room-action-btn"
            id="inviteBtn"
          >
            <i class="bi bi-person-plus"></i> Invite
          </button>
        </div>
      </div>

      <!-- Main Room Content -->
      <div class="room-container">
        <!-- Left Panel - Participants -->
        <div class="left-panel">
          <!-- Participants Panel -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">
                <i class="bi bi-people-fill"></i> Participants
              </div>
              <span class="badge bg-success rounded-pill" id="participantCount"
                >1</span
              >
            </div>
            <div class="panel-body">
              <div class="participants-list" id="participantsList">
                <div class="participant-item" data-user="DanePascual">
                  <div class="participant-avatar">
                    DP
                    <div class="status-indicator status-online"></div>
                  </div>
                  <div class="participant-info">
                    <div class="participant-name">DanePascual (You)</div>
                    <div class="participant-status">Host</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Panel - Main Chat Area -->
        <div class="right-panel">
          <!-- Chat Panel -->
          <div class="chat-container">
            <div class="chat-header">
              <div class="chat-title"><i class="bi bi-chat-dots"></i> Chat</div>
              <div id="callIndicator" style="display: none">
                <span class="badge bg-success"
                  ><i class="bi bi-camera-video-fill"></i> In Call</span
                >
              </div>
            </div>

            <div class="chat-messages" id="chatMessages">
              <div class="empty-state">
                <i class="bi bi-chat-dots empty-state-icon"></i>
                <div>No messages yet</div>
                <div>Start the conversation!</div>
              </div>
            </div>

            <div class="chat-input">
              <input
                type="text"
                placeholder="Type a message..."
                id="messageInput"
              />
              <div class="chat-actions">
                <button
                  class="chat-action-btn"
                  id="attachBtn"
                  title="Attach Image"
                >
                  <i class="bi bi-paperclip"></i>
                </button>
                <button class="chat-send" id="sendMessageBtn">
                  <i class="bi bi-send-fill"></i>
                </button>
              </div>
              <input
                type="file"
                class="file-input"
                id="fileInput"
                accept="image/*"
              />
            </div>
          </div>

          <!-- Video Call Button -->
          <button
            class="video-call-btn"
            id="videoCallBtn"
            title="Start Video Call"
          >
            <i class="bi bi-camera-video-fill"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Picture-in-Picture Video Container -->
    <div class="video-container" id="videoContainer">
      <div class="video-header" id="videoHeader">
        <div class="video-title">
          <i class="bi bi-camera-video"></i> Video Call
          <span class="maximized-indicator">
            <i class="bi bi-fullscreen"></i> Fullscreen
          </span>
        </div>
        <div class="video-actions">
          <button
            class="video-action-btn"
            id="minimizeBtn"
            title="Minimize (Alt+Down)"
          >
            <i class="bi bi-dash-lg"></i>
          </button>
          <button
            class="video-action-btn"
            id="maximizeBtn"
            title="Maximize (Alt+Up)"
          >
            <i class="bi bi-arrows-angle-expand"></i>
          </button>
          <button
            class="video-action-btn"
            id="closeVideoBtn"
            title="Close (Alt+L)"
          >
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <div class="video-body">
        <div class="video-placeholder" id="videoPlaceholder">
          <i class="bi bi-camera-video" style="font-size: 32px"></i>
          <div>Starting video call...</div>
        </div>

        <div class="video-grid" id="videoGrid" style="display: none">
          <!-- Video participants will appear here -->
        </div>
      </div>

      <div class="video-controls">
        <button class="video-control active" id="micBtn" title="Mute (Alt+M)">
          <i class="bi bi-mic-fill"></i>
        </button>
        <button
          class="video-control active"
          id="cameraBtn"
          title="Camera (Alt+V)"
        >
          <i class="bi bi-camera-video-fill"></i>
        </button>
        <button
          class="video-control"
          id="screenShareBtn"
          title="Share Screen (Alt+S)"
        >
          <i class="bi bi-display"></i>
        </button>
        <button
          class="video-control danger"
          id="leaveCallBtn"
          title="End Call (Alt+L)"
        >
          <i class="bi bi-telephone-x-fill"></i>
        </button>
      </div>
    </div>

    <!-- Room Settings Modal (Owner Only) -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Room Settings</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs mb-3" id="settingsTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="room-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#room"
                  type="button"
                  role="tab"
                  aria-selected="true"
                >
                  <i class="bi bi-gear me-2"></i>Room
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="participants-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#participants"
                  type="button"
                  role="tab"
                  aria-selected="false"
                >
                  <i class="bi bi-people me-2"></i>Participants
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="files-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#files"
                  type="button"
                  role="tab"
                  aria-selected="false"
                >
                  <i class="bi bi-file-earmark me-2"></i>Files
                </button>
              </li>
            </ul>
            <div class="tab-content" id="settingsTabContent">
              <!-- Room Settings Tab -->
              <div
                class="tab-pane fade show active"
                id="room"
                role="tabpanel"
                aria-labelledby="room-tab"
              >
                <div class="mb-3">
                  <label for="roomNameInput" class="form-label"
                    >Room Name</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="roomNameInput"
                    value=""
                  />
                </div>
                <div class="mb-3">
                  <label for="roomDescInput" class="form-label"
                    >Description</label
                  >
                  <textarea
                    class="form-control"
                    id="roomDescInput"
                    rows="3"
                  ></textarea>
                </div>
              </div>

              <!-- Participants Tab -->
              <div
                class="tab-pane fade"
                id="participants"
                role="tabpanel"
                aria-labelledby="participants-tab"
              >
                <div id="participantsList2">
                  <!-- Participants list for management -->
                </div>
              </div>

              <!-- Files Tab -->
              <div
                class="tab-pane fade"
                id="files"
                role="tabpanel"
                aria-labelledby="files-tab"
              >
                <div id="filesList" class="files-list">
                  <!-- Shared files will be listed here -->
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-success" id="saveSettingsBtn">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Invite Modal -->
    <div class="modal fade" id="inviteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="inviteModalTitle">
              Invite to Study Room
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="inviteLink" class="form-label"
                >Share this link with your classmates</label
              >
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  id="inviteLink"
                  readonly
                />
                <button
                  class="btn btn-outline-success"
                  type="button"
                  id="copyLinkBtn"
                >
                  <i class="bi bi-clipboard"></i> Copy
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-success" id="sendInvitesBtn">
              <i class="bi bi-send"></i> Send Invites
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
      /**
       * StudyGroup - Virtual Study Room with Picture-in-Picture Video Call
       *
       * Features:
       * - Draggable, resizable video container
       * - Chat-focused interface with floating video
       * - Dark mode support
       * - Responsive design
       */

      // Current Session Info
      const CURRENT_SESSION = {
        utcTime: "2025-07-11 11:15:22", // Updated UTC time
        philippinesTime: "2025-07-11 19:15:22", // Updated Philippines time (UTC+8)
        user: "DanePascual",
        timezone: "Asia/Manila",
      };

      // Global variables
      let currentRoomData = null;
      let isOwner = false;
      let participants = [];
      let messages = [];
      let sharedFiles = [];
      let isInCall = false;
      let isMuted = false;
      let isCameraOff = false;
      let isScreenSharing = false;
      let videoMinimized = false;
      let videoMaximized = false;
      let dragStartX, dragStartY;
      let dragOffsetX, dragOffsetY;

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        console.log(
          `📹 Study Room loaded for ${CURRENT_SESSION.user} at ${CURRENT_SESSION.philippinesTime} Philippines Time`
        );

        initializeRoomData();
        initializeTheme();
        initializeChat();
        initializeParticipants();
        initializeVideoPiP();

        if (currentRoomData) {
          updateRoomDisplay();
          if (isOwner) {
            initializeOwnerSettings();
          }
        }

        // Add keyboard shortcuts
        setupKeyboardShortcuts();
      });

      // Theme management
      function initializeTheme() {
        const themeToggle = document.getElementById("themeToggle");
        const body = document.body;

        const savedTheme = localStorage.getItem("theme") || "light";
        if (savedTheme === "dark") {
          body.classList.add("dark-mode");
          themeToggle.innerHTML = '<i class="bi bi-sun"></i>';
        }

        themeToggle.addEventListener("click", () => {
          body.classList.toggle("dark-mode");
          const isDark = body.classList.contains("dark-mode");
          themeToggle.innerHTML = isDark
            ? '<i class="bi bi-sun"></i>'
            : '<i class="bi bi-moon"></i>';
          localStorage.setItem("theme", isDark ? "dark" : "light");

          showToast(
            `Theme switched to ${isDark ? "dark" : "light"} mode`,
            "info"
          );
        });
      }

      // Initialize room data
      function initializeRoomData() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get("room");

        if (!roomId) {
          window.location.href = "study-rooms.html";
          return;
        }

        const allRoomsData = JSON.parse(
          localStorage.getItem("allRoomsData") || "{}"
        );

        if (allRoomsData[roomId]) {
          currentRoomData = allRoomsData[roomId];
        } else {
          currentRoomData = {
            id: roomId,
            name: "Study Room",
            description: "A collaborative study room",
            creator: CURRENT_SESSION.user,
            createdAt: CURRENT_SESSION.utcTime,
            participants: [CURRENT_SESSION.user],
            isActive: true,
            timezone: CURRENT_SESSION.timezone,
          };

          // Save new room
          allRoomsData[roomId] = currentRoomData;
          localStorage.setItem("allRoomsData", JSON.stringify(allRoomsData));
        }

        isOwner = currentRoomData.creator === CURRENT_SESSION.user;

        // Initialize participants
        participants = [
          {
            id: CURRENT_SESSION.user,
            name: CURRENT_SESSION.user,
            avatar: "DP",
            status: "online",
            isHost: isOwner,
            inCall: false,
          },
        ];
      }

      // Update room display
      function updateRoomDisplay() {
        document.getElementById("roomNameDisplay").textContent =
          currentRoomData.name;
        document.getElementById(
          "pageTitle"
        ).textContent = `${currentRoomData.name} - StudyGroup`;
        document.getElementById("roomTitleDisplay").textContent =
          currentRoomData.name;
        document.getElementById(
          "roomCreatedTime"
        ).textContent = `Created on ${currentRoomData.createdAt} UTC`;
        document.getElementById("participantCount").textContent =
          participants.length;

        const baseUrl = window.location.origin + window.location.pathname;
        const inviteUrl = `${baseUrl}?room=${currentRoomData.id}&invite=true`;
        document.getElementById("inviteLink").value = inviteUrl;
      }

      // Initialize PiP video functionality
      function initializeVideoPiP() {
        const videoCallBtn = document.getElementById("videoCallBtn");
        const videoContainer = document.getElementById("videoContainer");
        const videoHeader = document.getElementById("videoHeader");
        const minimizeBtn = document.getElementById("minimizeBtn");
        const maximizeBtn = document.getElementById("maximizeBtn");
        const closeVideoBtn = document.getElementById("closeVideoBtn");
        const micBtn = document.getElementById("micBtn");
        const cameraBtn = document.getElementById("cameraBtn");
        const screenShareBtn = document.getElementById("screenShareBtn");
        const leaveCallBtn = document.getElementById("leaveCallBtn");
        const callIndicator = document.getElementById("callIndicator");

        // Start/end call
        videoCallBtn.addEventListener("click", () => {
          if (!isInCall) {
            startVideoCall();
          } else {
            // If call is active but container is not visible, show it
            if (!videoContainer.classList.contains("active")) {
              videoContainer.classList.add("active");
            } else {
              endVideoCall();
            }
          }
        });

        // Window controls
        minimizeBtn.addEventListener("click", () => {
          videoMinimized = !videoMinimized;
          videoContainer.classList.toggle("minimized", videoMinimized);
          videoMaximized = false;
          videoContainer.classList.remove("maximized");
          minimizeBtn.innerHTML = videoMinimized
            ? '<i class="bi bi-arrows-angle-expand"></i>'
            : '<i class="bi bi-dash-lg"></i>';
          minimizeBtn.title = videoMinimized ? "Restore" : "Minimize";

          // Update maximize button when we minimize
          maximizeBtn.innerHTML = '<i class="bi bi-arrows-angle-expand"></i>';
          maximizeBtn.title = "Maximize (Alt+Up)";
        });

        // Updated maximize function for true fullscreen
        maximizeBtn.addEventListener("click", () => {
          videoMaximized = !videoMaximized;
          videoContainer.classList.toggle("maximized", videoMaximized);
          videoMinimized = false;
          videoContainer.classList.remove("minimized");

          if (videoMaximized) {
            // True fullscreen mode
            videoContainer.style.position = "fixed";
            videoContainer.style.top = "0";
            videoContainer.style.left = "0";
            videoContainer.style.width = "100%";
            videoContainer.style.height = "100%";
            videoContainer.style.zIndex = "2000";
            videoContainer.style.borderRadius = "0";
            videoContainer.style.border = "none";

            maximizeBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
            maximizeBtn.title = "Exit Fullscreen (Alt+Down)";
          } else {
            // Restore to normal floating window
            videoContainer.style.position = "fixed";
            videoContainer.style.width = "360px";
            videoContainer.style.height = "240px";
            videoContainer.style.bottom = "100px";
            videoContainer.style.right = "30px";
            videoContainer.style.top = "auto";
            videoContainer.style.left = "auto";
            videoContainer.style.zIndex = "1000";
            videoContainer.style.borderRadius = "12px";
            videoContainer.style.border = "2px solid var(--primary-color)";

            maximizeBtn.innerHTML = '<i class="bi bi-arrows-angle-expand"></i>';
            maximizeBtn.title = "Maximize (Alt+Up)";
          }

          minimizeBtn.innerHTML = '<i class="bi bi-dash-lg"></i>';
          minimizeBtn.title = "Minimize (Alt+Down)";
        });

        closeVideoBtn.addEventListener("click", endVideoCall);

        // Call controls
        micBtn.addEventListener("click", () => toggleMicrophone());
        cameraBtn.addEventListener("click", () => toggleCamera());
        screenShareBtn.addEventListener("click", () => toggleScreenShare());
        leaveCallBtn.addEventListener("click", endVideoCall);

        // Double-click header to toggle maximize
        videoHeader.addEventListener("dblclick", (e) => {
          videoMaximized = !videoMaximized;
          if (videoMaximized) {
            // Call the maximize function directly
            maximizeBtn.click();
          } else {
            // Call the restore function
            maximizeBtn.click();
          }
        });

        // Make video container draggable
        videoHeader.addEventListener("mousedown", startDrag);
        document.addEventListener("mousemove", drag);
        document.addEventListener("mouseup", endDrag);

        // Touch support for mobile
        videoHeader.addEventListener("touchstart", startDragTouch);
        document.addEventListener("touchmove", dragTouch);
        document.addEventListener("touchend", endDrag);

        // Prevent defaults on header to enable drag
        videoHeader.addEventListener("dragstart", (e) => e.preventDefault());
      }

      // Dragging functionality - IMPROVED
      function startDrag(e) {
        const videoContainer = document.getElementById("videoContainer");

        // If maximized, restore to normal size first when user tries to drag
        if (videoMaximized) {
          videoMaximized = false;
          videoContainer.classList.remove("maximized");

          // Update maximize button appearance
          const maximizeBtn = document.getElementById("maximizeBtn");
          maximizeBtn.innerHTML = '<i class="bi bi-arrows-angle-expand"></i>';
          maximizeBtn.title = "Maximize (Alt+Up)";

          // Position the container near the cursor for better UX
          videoContainer.style.position = "fixed";
          videoContainer.style.width = "360px";
          videoContainer.style.height = "240px";
          videoContainer.style.bottom = "auto";
          videoContainer.style.right = "auto";
          videoContainer.style.top = e.clientY - 30 + "px";
          videoContainer.style.left = e.clientX - 100 + "px";
          videoContainer.style.zIndex = "1000";
          videoContainer.style.borderRadius = "12px";
          videoContainer.style.border = "2px solid var(--primary-color)";

          // Add a slight delay before starting the drag to avoid visual jump
          setTimeout(() => {
            const rect = videoContainer.getBoundingClientRect();
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            dragOffsetX = rect.left;
            dragOffsetY = rect.top;
            videoContainer.classList.add("dragging");
          }, 10);
        } else {
          // Normal drag behavior for non-maximized window
          const rect = videoContainer.getBoundingClientRect();
          dragStartX = e.clientX;
          dragStartY = e.clientY;
          dragOffsetX = rect.left;
          dragOffsetY = rect.top;
          videoContainer.classList.add("dragging");
        }

        e.preventDefault();
      }

      // Improved drag function that works regardless of maximize state
      function drag(e) {
        if (!dragStartX || !dragStartY) return;

        const videoContainer = document.getElementById("videoContainer");
        const rect = videoContainer.getBoundingClientRect();

        const deltaX = e.clientX - dragStartX;
        const deltaY = e.clientY - dragStartY;

        // Constrain to viewport
        let newLeft = dragOffsetX + deltaX;
        let newTop = dragOffsetY + deltaY;

        // Keep within viewport bounds
        newLeft = Math.max(
          0,
          Math.min(window.innerWidth - rect.width, newLeft)
        );
        newTop = Math.max(
          0,
          Math.min(window.innerHeight - rect.height, newTop)
        );

        videoContainer.style.left = newLeft + "px";
        videoContainer.style.top = newTop + "px";
        videoContainer.style.right = "auto";
        videoContainer.style.bottom = "auto";

        e.preventDefault();
      }

      // Touch support - IMPROVED
      function startDragTouch(e) {
        const videoContainer = document.getElementById("videoContainer");
        const touch = e.touches[0];

        // If maximized, restore to normal size first
        if (videoMaximized) {
          videoMaximized = false;
          videoContainer.classList.remove("maximized");

          // Update maximize button appearance
          const maximizeBtn = document.getElementById("maximizeBtn");
          maximizeBtn.innerHTML = '<i class="bi bi-arrows-angle-expand"></i>';
          maximizeBtn.title = "Maximize (Alt+Up)";

          // Position the container near the touch point
          videoContainer.style.position = "fixed";
          videoContainer.style.width = "360px";
          videoContainer.style.height = "240px";
          videoContainer.style.bottom = "auto";
          videoContainer.style.right = "auto";
          videoContainer.style.top = touch.clientY - 30 + "px";
          videoContainer.style.left = touch.clientX - 100 + "px";
          videoContainer.style.zIndex = "1000";
          videoContainer.style.borderRadius = "12px";
          videoContainer.style.border = "2px solid var(--primary-color)";

          setTimeout(() => {
            const rect = videoContainer.getBoundingClientRect();
            dragStartX = touch.clientX;
            dragStartY = touch.clientY;
            dragOffsetX = rect.left;
            dragOffsetY = rect.top;
            videoContainer.classList.add("dragging");
          }, 10);
        } else {
          const rect = videoContainer.getBoundingClientRect();
          dragStartX = touch.clientX;
          dragStartY = touch.clientY;
          dragOffsetX = rect.left;
          dragOffsetY = rect.top;
          videoContainer.classList.add("dragging");
        }

        e.preventDefault();
      }

      function dragTouch(e) {
        if (!dragStartX || !dragStartY) return;

        const videoContainer = document.getElementById("videoContainer");
        const rect = videoContainer.getBoundingClientRect();
        const touch = e.touches[0];

        const deltaX = touch.clientX - dragStartX;
        const deltaY = touch.clientY - dragStartY;

        // Constrain to viewport
        let newLeft = dragOffsetX + deltaX;
        let newTop = dragOffsetY + deltaY;

        // Keep within viewport bounds
        newLeft = Math.max(
          0,
          Math.min(window.innerWidth - rect.width, newLeft)
        );
        newTop = Math.max(
          0,
          Math.min(window.innerHeight - rect.height, newTop)
        );

        videoContainer.style.left = newLeft + "px";
        videoContainer.style.top = newTop + "px";
        videoContainer.style.right = "auto";
        videoContainer.style.bottom = "auto";

        e.preventDefault();
      }

      function endDrag() {
        const videoContainer = document.getElementById("videoContainer");
        videoContainer.classList.remove("dragging");
        dragStartX = null;
        dragStartY = null;
      }

      // Video call management
      function startVideoCall() {
        isInCall = true;

        // Update UI
        const videoCallBtn = document.getElementById("videoCallBtn");
        const videoContainer = document.getElementById("videoContainer");
        const callIndicator = document.getElementById("callIndicator");

        videoCallBtn.classList.add("active");
        videoCallBtn.innerHTML = '<i class="bi bi-telephone-x-fill"></i>';
        videoCallBtn.title = "End Call";

        videoContainer.classList.add("active");
        callIndicator.style.display = "block";

        // Show loading indicator first
        document.getElementById("videoPlaceholder").innerHTML = `
          <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div style="margin-top: 15px;">Connecting to call...</div>
        `;

        // Simulate connection delay
        setTimeout(() => {
          // Hide placeholder, show video grid
          document.getElementById("videoPlaceholder").style.display = "none";
          document.getElementById("videoGrid").style.display = "grid";

          // Add self to video grid
          const videoGrid = document.getElementById("videoGrid");
          videoGrid.innerHTML = `
            <div class="video-participant" id="self-video">
              <i class="bi bi-person-circle" style="font-size: 36px;"></i>
              <div class="participant-label">${CURRENT_SESSION.user} (You)</div>
            </div>
          `;

          // Update participant status
          updateParticipantCallStatus(CURRENT_SESSION.user, true);

          showToast("Joined video call", "success");

          // Only show essential system messages
          addChatMessage(
            "system",
            `${CURRENT_SESSION.user} joined the call`,
            true
          );
        }, 1500);
      }

      function endVideoCall() {
        isInCall = false;

        // Update UI
        const videoCallBtn = document.getElementById("videoCallBtn");
        const videoContainer = document.getElementById("videoContainer");
        const callIndicator = document.getElementById("callIndicator");

        videoCallBtn.classList.remove("active");
        videoCallBtn.innerHTML = '<i class="bi bi-camera-video-fill"></i>';
        videoCallBtn.title = "Start Video Call";

        videoContainer.classList.remove("active", "minimized", "maximized");
        callIndicator.style.display = "none";

        // Reset video container
        document.getElementById("videoPlaceholder").style.display = "flex";
        document.getElementById("videoPlaceholder").innerHTML = `
          <i class="bi bi-camera-video" style="font-size: 32px;"></i>
          <div>Starting video call...</div>
        `;
        document.getElementById("videoGrid").style.display = "none";

        // Reset container style to default
        videoContainer.style.position = "fixed";
        videoContainer.style.width = "360px";
        videoContainer.style.height = "240px";
        videoContainer.style.bottom = "100px";
        videoContainer.style.right = "30px";
        videoContainer.style.top = "auto";
        videoContainer.style.left = "auto";
        videoContainer.style.zIndex = "1000";
        videoContainer.style.borderRadius = "12px";
        videoContainer.style.border = "2px solid var(--primary-color)";

        // Reset controls
        document.getElementById("minimizeBtn").innerHTML =
          '<i class="bi bi-dash-lg"></i>';
        document.getElementById("minimizeBtn").title = "Minimize (Alt+Down)";
        document.getElementById("maximizeBtn").innerHTML =
          '<i class="bi bi-arrows-angle-expand"></i>';
        document.getElementById("maximizeBtn").title = "Maximize (Alt+Up)";

        isMuted = false;
        isCameraOff = false;
        isScreenSharing = false;
        videoMinimized = false;
        videoMaximized = false;
        updateVideoControls();

        // Update participant status
        updateParticipantCallStatus(CURRENT_SESSION.user, false);

        showToast("Left video call", "info");

        // Only show essential system messages
        addChatMessage("system", `${CURRENT_SESSION.user} left the call`, true);
      }

      function toggleMicrophone() {
        isMuted = !isMuted;
        updateVideoControls();

        const status = isMuted ? "muted" : "unmuted";
        showToast(`Microphone ${status}`, "info");

        // No chat message for microphone changes - cleaner chat experience
      }

      function toggleCamera() {
        isCameraOff = !isCameraOff;
        updateVideoControls();

        // Update video display
        const selfVideo = document.getElementById("self-video");
        if (selfVideo) {
          if (isCameraOff) {
            selfVideo.innerHTML = `
              <i class="bi bi-person-circle" style="font-size: 36px;"></i>
              <div class="participant-label">${CURRENT_SESSION.user} (You)</div>
            `;
          } else {
            selfVideo.innerHTML = `
              <div style="font-size: 14px;">Camera On</div>
              <div class="participant-label">${CURRENT_SESSION.user} (You)</div>
            `;
          }
        }

        const status = isCameraOff ? "turned off" : "turned on";
        showToast(`Camera ${status}`, "info");

        // No chat message for camera changes - cleaner chat experience
      }

      function toggleScreenShare() {
        isScreenSharing = !isScreenSharing;
        updateVideoControls();

        // Update video display if sharing
        const selfVideo = document.getElementById("self-video");
        if (selfVideo && isScreenSharing) {
          selfVideo.innerHTML = `
            <div style="text-align: center;">
              <i class="bi bi-display" style="font-size: 24px;"></i>
              <div style="font-size: 12px;">Screen sharing active</div>
            </div>
            <div class="participant-label">${CURRENT_SESSION.user} (You)</div>
          `;
        } else if (selfVideo) {
          // Return to normal view based on camera state
          selfVideo.innerHTML = isCameraOff
            ? `<i class="bi bi-person-circle" style="font-size: 36px;"></i>
             <div class="participant-label">${CURRENT_SESSION.user} (You)</div>`
            : `<div style="font-size: 14px;">Camera On</div>
             <div class="participant-label">${CURRENT_SESSION.user} (You)</div>`;
        }

        const status = isScreenSharing
          ? "started sharing your screen"
          : "stopped sharing your screen";
        showToast(`You ${status}`, "info");

        // No chat message for screen sharing changes - cleaner chat experience
      }

      function updateVideoControls() {
        const micBtn = document.getElementById("micBtn");
        const cameraBtn = document.getElementById("cameraBtn");
        const screenShareBtn = document.getElementById("screenShareBtn");

        // Update microphone button
        if (isMuted) {
          micBtn.classList.remove("active");
          micBtn.innerHTML = '<i class="bi bi-mic-mute-fill"></i>';
          micBtn.title = "Unmute (Alt+M)";
        } else {
          micBtn.classList.add("active");
          micBtn.innerHTML = '<i class="bi bi-mic-fill"></i>';
          micBtn.title = "Mute (Alt+M)";
        }

        // Update camera button
        if (isCameraOff) {
          cameraBtn.classList.remove("active");
          cameraBtn.innerHTML = '<i class="bi bi-camera-video-off-fill"></i>';
          cameraBtn.title = "Turn Camera On (Alt+V)";
        } else {
          cameraBtn.classList.add("active");
          cameraBtn.innerHTML = '<i class="bi bi-camera-video-fill"></i>';
          cameraBtn.title = "Turn Camera Off (Alt+V)";
        }

        // Update screen share button
        if (isScreenSharing) {
          screenShareBtn.classList.add("active");
          screenShareBtn.title = "Stop Sharing (Alt+S)";
        } else {
          screenShareBtn.classList.remove("active");
          screenShareBtn.title = "Share Screen (Alt+S)";
        }
      }

      // Initialize chat functionality
      function initializeChat() {
        const messageInput = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendMessageBtn");
        const attachBtn = document.getElementById("attachBtn");
        const fileInput = document.getElementById("fileInput");

        // Send message on Enter key
        messageInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        sendBtn.addEventListener("click", sendMessage);

        // Attach file functionality
        attachBtn.addEventListener("click", function () {
          fileInput.click();
        });

        fileInput.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file && file.type.startsWith("image/")) {
            // Show loading indicator
            showToast("Uploading image...", "info");

            // Simulate upload delay
            setTimeout(() => {
              sendImageMessage(file);
              fileInput.value = "";
            }, 800);
          } else if (file) {
            showToast("Please select an image file", "error");
            fileInput.value = "";
          }
        });
      }

      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const text = messageInput.value.trim();

        if (!text) return;

        addChatMessage(CURRENT_SESSION.user, text);
        messageInput.value = "";
        messageInput.focus();
      }

      function sendImageMessage(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const imageUrl = e.target.result;

          // Add to shared files
          addSharedFile({
            name: file.name || `Image ${new Date().toLocaleTimeString()}`,
            url: imageUrl,
            type: "image",
            size: file.size,
          });

          // Send to chat as before
          addChatMessage(CURRENT_SESSION.user, "", false, imageUrl);
        };
        reader.readAsDataURL(file);
      }

      function addSharedFile(file) {
        sharedFiles.push({
          id: Date.now(),
          name: file.name,
          url: file.url,
          type: file.type || "image",
          sender: CURRENT_SESSION.user,
          timestamp: new Date().toISOString(),
        });

        // Update files list in settings if it's open
        updateFilesListInSettings();
      }

      function updateFilesListInSettings() {
        const filesListElement = document.getElementById("filesList");
        if (!filesListElement) return;

        if (sharedFiles.length === 0) {
          filesListElement.innerHTML = `
            <div class="text-center p-4 text-muted">
              <i class="bi bi-file-earmark-x" style="font-size: 2rem;"></i>
              <p class="mt-2">No files have been shared in this session</p>
            </div>
          `;
          return;
        }

        filesListElement.innerHTML = sharedFiles
          .map((file) => {
            const date = new Date(file.timestamp);
            const formattedDate = date.toLocaleString();
            return `
            <div class="card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-file-earmark-image text-primary" style="font-size: 1.5rem;"></i>
                    <div>
                      <div class="fw-bold">${file.name}</div>
                      <small class="text-muted">Shared by ${file.sender} • ${formattedDate}</small>
                    </div>
                  </div>
                  <a href="${file.url}" class="btn btn-sm btn-outline-primary" download="${file.name}">
                    <i class="bi bi-download"></i>
                  </a>
                </div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function addChatMessage(author, text, isSystem = false, imageUrl = null) {
        const chatMessages = document.getElementById("chatMessages");

        // Remove empty state if it exists
        const emptyState = chatMessages.querySelector(".empty-state");
        if (emptyState) {
          emptyState.remove();
        }

        const now = new Date();
        const timeStr = now.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });

        const messageElement = document.createElement("div");

        if (isSystem) {
          messageElement.className = "chat-message";
          messageElement.innerHTML = `
            <div class="message-avatar" style="background: #999;">
              <i class="bi bi-info-circle"></i>
            </div>
            <div>
              <div class="message-bubble">
                <div class="message-content" style="font-style: italic; color: var(--medium-text);">${text}</div>
                <div class="message-meta">
                  <span>System</span>
                  <span>${timeStr}</span>
                </div>
              </div>
            </div>
          `;
        } else {
          const isOwnMessage = author === CURRENT_SESSION.user;
          const avatar = isOwnMessage
            ? "DP"
            : author.substring(0, 2).toUpperCase();

          messageElement.className = `chat-message ${
            isOwnMessage ? "self" : ""
          }`;

          let contentHtml = "";
          if (imageUrl) {
            contentHtml = `<img src="${imageUrl}" alt="Shared image" class="message-image" onclick="openImageModal('${imageUrl}')">`;
          } else {
            contentHtml = text;
          }

          messageElement.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div>
              <div class="message-bubble">
                <div class="message-content">${contentHtml}</div>
                <div class="message-meta">
                  <span>${isOwnMessage ? "You" : author}</span>
                  <span>${timeStr}</span>
                </div>
              </div>
            </div>
          `;
        }

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Store message
        messages.push({
          id: Date.now(),
          author,
          text,
          imageUrl,
          timestamp: now.toISOString(),
          isSystem,
        });
      }

      // Initialize participants
      function initializeParticipants() {
        updateParticipantsList();
      }

      function updateParticipantsList() {
        const participantsList = document.getElementById("participantsList");

        participantsList.innerHTML = participants
          .map((participant) => {
            const canKick = isOwner && participant.id !== CURRENT_SESSION.user;

            return `
            <div class="participant-item" data-user="${participant.id}">
              <div class="participant-avatar">${participant.avatar}
                <div class="status-indicator ${
                  participant.inCall ? "status-in-call" : "status-online"
                }"></div>
              </div>
              <div class="participant-info">
                <div class="participant-name">${participant.name}${
              participant.id === CURRENT_SESSION.user ? " (You)" : ""
            }</div>
                <div class="participant-status">${
                  participant.isHost
                    ? "Host"
                    : participant.inCall
                    ? "In Call"
                    : "Online"
                }</div>
              </div>
              ${
                canKick
                  ? `
                <div class="participant-actions">
                  <button class="kick-btn" onclick="kickParticipant('${participant.id}')" title="Kick user">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              `
                  : ""
              }
            </div>
          `;
          })
          .join("");

        document.getElementById("participantCount").textContent =
          participants.length;
      }

      function updateParticipantCallStatus(userId, inCall) {
        const participant = participants.find((p) => p.id === userId);
        if (participant) {
          participant.inCall = inCall;
          updateParticipantsList();
        }
      }

      // Owner settings functionality
      function initializeOwnerSettings() {
        const settingsBtn = document.getElementById("settingsBtn");
        settingsBtn.style.display = "block";

        settingsBtn.addEventListener("click", () => {
          openSettingsModal();
        });

        document
          .getElementById("saveSettingsBtn")
          .addEventListener("click", () => {
            saveRoomSettings();
          });
      }

      function openSettingsModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("settingsModal")
        );

        // Populate current values
        document.getElementById("roomNameInput").value = currentRoomData.name;
        document.getElementById("roomDescInput").value =
          currentRoomData.description || "";

        // Populate participants list for management
        const participantsList2 = document.getElementById("participantsList2");
        participantsList2.innerHTML = participants
          .map(
            (participant) => `
          <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
            <div class="d-flex align-items-center gap-2">
              <div class="participant-avatar" style="width: 24px; height: 24px; font-size: 12px;">${
                participant.avatar
              }</div>
              <span>${participant.name}${
              participant.id === CURRENT_SESSION.user ? " (You)" : ""
            }</span>
              ${
                participant.isHost
                  ? '<span class="badge bg-primary">Host</span>'
                  : ""
              }
            </div>
            ${
              participant.id !== CURRENT_SESSION.user
                ? `
              <button class="btn btn-outline-danger btn-sm" onclick="kickParticipant('${participant.id}')">
                <i class="bi bi-x-lg"></i> Kick
              </button>
            `
                : ""
            }
          </div>
        `
          )
          .join("");

        // Update files list
        updateFilesListInSettings();

        modal.show();
      }

      function saveRoomSettings() {
        const newName = document.getElementById("roomNameInput").value.trim();
        const newDesc = document.getElementById("roomDescInput").value.trim();

        if (!newName) {
          showToast("Room name cannot be empty", "error");
          return;
        }

        // Update room data
        currentRoomData.name = newName;
        currentRoomData.description = newDesc;

        // Update display
        updateRoomDisplay();

        // Save to localStorage
        const allRoomsData = JSON.parse(
          localStorage.getItem("allRoomsData") || "{}"
        );
        allRoomsData[currentRoomData.id] = currentRoomData;
        localStorage.setItem("allRoomsData", JSON.stringify(allRoomsData));

        // Close modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("settingsModal")
        );
        modal.hide();

        showToast("Room settings updated", "success");
        addChatMessage("system", `Room name changed to "${newName}"`, true);
      }

      // Kick participant (owner only)
      window.kickParticipant = function (userId) {
        if (!isOwner) {
          showToast("Only the room owner can kick participants", "error");
          return;
        }

        if (userId === CURRENT_SESSION.user) {
          showToast("You cannot kick yourself", "error");
          return;
        }

        if (confirm(`Are you sure you want to kick ${userId} from the room?`)) {
          // Remove participant
          participants = participants.filter((p) => p.id !== userId);
          updateParticipantsList();

          showToast(`${userId} has been kicked from the room`, "success");
          addChatMessage("system", `${userId} was kicked from the room`, true);
        }
      };

      // Open image in modal
      window.openImageModal = function (imageUrl) {
        // Create a simple image modal
        const modal = document.createElement("div");
        modal.className = "modal fade";
        modal.innerHTML = `
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body text-center">
                <img src="${imageUrl}" alt="Shared image" style="max-width: 100%; height: auto;">
              </div>
              <div class="modal-footer">
                <a href="${imageUrl}" class="btn btn-outline-primary" download target="_blank">
                  <i class="bi bi-download"></i> Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();

        modal.addEventListener("hidden.bs.modal", () => {
          modal.remove();
        });
      };

      // Setup keyboard shortcuts
      function setupKeyboardShortcuts() {
        document.addEventListener("keydown", function (e) {
          // Alt+M to toggle microphone when in call
          if (e.altKey && e.key === "m" && isInCall) {
            e.preventDefault();
            toggleMicrophone();
          }

          // Alt+V to toggle camera when in call
          if (e.altKey && e.key === "v" && isInCall) {
            e.preventDefault();
            toggleCamera();
          }

          // Alt+S to toggle screen share when in call
          if (e.altKey && e.key === "s" && isInCall) {
            e.preventDefault();
            toggleScreenShare();
          }

          // Alt+J to join call when not in call
          if (e.altKey && e.key === "j" && !isInCall) {
            e.preventDefault();
            startVideoCall();
          }

          // Alt+L to leave call when in call
          if (e.altKey && e.key === "l" && isInCall) {
            e.preventDefault();
            endVideoCall();
          }

          // Alt+Up to maximize video window
          if (e.altKey && e.key === "ArrowUp" && isInCall && !videoMaximized) {
            e.preventDefault();
            document.getElementById("maximizeBtn").click();
          }

          // Alt+Down to minimize/restore video window
          if (e.altKey && e.key === "ArrowDown" && isInCall && videoMaximized) {
            e.preventDefault();
            document.getElementById("maximizeBtn").click();
          } else if (
            e.altKey &&
            e.key === "ArrowDown" &&
            isInCall &&
            !videoMinimized
          ) {
            e.preventDefault();
            document.getElementById("minimizeBtn").click();
          }

          // Escape to close sidebar on mobile or restore video from maximized
          if (e.key === "Escape") {
            const sidebar = document.getElementById("sidebar");
            if (
              window.innerWidth <= 768 &&
              sidebar.classList.contains("open")
            ) {
              setSidebar(false);
            } else if (isInCall && videoMaximized) {
              // If video is maximized, restore it
              document.getElementById("maximizeBtn").click();
            }
          }
        });
      }

      // Initialize invite system
      document
        .getElementById("inviteBtn")
        .addEventListener("click", function () {
          const modal = new bootstrap.Modal(
            document.getElementById("inviteModal")
          );
          modal.show();
        });

      document
        .getElementById("copyLinkBtn")
        .addEventListener("click", function () {
          const inviteLink = document.getElementById("inviteLink");
          inviteLink.select();
          navigator.clipboard
            .writeText(inviteLink.value)
            .then(() => {
              showToast("Invite link copied to clipboard", "success");
            })
            .catch(() => {
              document.execCommand("copy");
              showToast("Invite link copied to clipboard", "success");
            });
        });

      // Sidebar functionality
      const sidebar = document.getElementById("sidebar");
      const mainContent = document.getElementById("mainContent");
      const menuToggle = document.getElementById("menuToggle");

      function setSidebar(open) {
        if (open) {
          sidebar.classList.add("open");
          mainContent.classList.add("shifted");
        } else {
          sidebar.classList.remove("open");
          mainContent.classList.remove("shifted");
        }
      }

      if (window.innerWidth > 768) setSidebar(true);

      menuToggle.addEventListener("click", function () {
        setSidebar(!sidebar.classList.contains("open"));
      });

      window.goToProfile = function () {
        window.location.href = "profile.html";
      };

      // Toast notification system
      function showToast(message, type = "success") {
        const toastContainer = document.getElementById("toastContainer");
        const toastId = "toast-" + Date.now();

        const iconMap = {
          success: "bi-check-circle-fill",
          error: "bi-exclamation-circle-fill",
          info: "bi-info-circle-fill",
        };

        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.id = toastId;

        toast.innerHTML = `
          <div class="toast-icon">
            <i class="bi ${iconMap[type]}"></i>
          </div>
          <div class="toast-content">
            <div class="toast-title">${
              type.charAt(0).toUpperCase() + type.slice(1)
            }</div>
            <div class="toast-message">${message}</div>
          </div>
          <div class="toast-close" onclick="this.parentElement.style.opacity = 0; setTimeout(() => this.parentElement.remove(), 300);">
            <i class="bi bi-x"></i>
          </div>
        `;

        toastContainer.appendChild(toast);

        // Auto hide after 4 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.style.opacity = "0";
            setTimeout(() => toast.remove(), 300);
          }
        }, 4000);
      }

      // Handle window resize for responsive layout
      window.addEventListener("resize", function () {
        if (window.innerWidth > 768) {
          if (!sidebar.classList.contains("open")) {
            setSidebar(true);
          }
        } else {
          if (sidebar.classList.contains("open")) {
            setSidebar(false);
          }
        }
      });

      // Auto-save room data
      const autoSaveInterval = setInterval(() => {
        if (currentRoomData) {
          const allRoomsData = JSON.parse(
            localStorage.getItem("allRoomsData") || "{}"
          );
          allRoomsData[currentRoomData.id] = {
            ...currentRoomData,
            lastActivity: new Date().toISOString(),
          };
          localStorage.setItem("allRoomsData", JSON.stringify(allRoomsData));
          console.log(
            "Room data auto-saved: " + new Date().toLocaleTimeString()
          );
        }
      }, 30000);

      // Clean up interval when leaving page
      window.addEventListener("beforeunload", () => {
        clearInterval(autoSaveInterval);

        // Leave call if active
        if (isInCall) {
          // In a real app, you would signal to other users that you've left
          updateParticipantCallStatus(CURRENT_SESSION.user, false);
        }
      });

      // Initial welcome message
      setTimeout(() => {
        showToast(
          `Welcome to ${
            currentRoomData ? currentRoomData.name : "the study room"
          }!`,
          "success"
        );
        if (currentRoomData && isOwner) {
          addChatMessage(
            "system",
            `Room created by ${CURRENT_SESSION.user}`,
            true
          );
        }

        // More concise welcome message
        addChatMessage(
          "system",
          "Click the camera button to start a video call. Double-click the video header for fullscreen mode.",
          true
        );
      }, 1000);

      console.log(
        `Study Room ready for ${CURRENT_SESSION.user} at ${CURRENT_SESSION.philippinesTime} Philippines Time`
      );
      console.log(`Current session: ${CURRENT_SESSION.utcTime} UTC`);
      console.log(`Tip: Access shared files through the Settings > Files tab`);
    </script>
  </body>
</html>
